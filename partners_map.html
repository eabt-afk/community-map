<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Partners Map</title>

<!-- Raleway font -->
<link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>

<style>
:root{
  --hotpink: hsla(323, 98%, 49%, 0.9);
  --hotpink-border: hsla(323, 98%, 35%, 1);
}

body{
  margin:0;
  font-family:"Raleway",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  background:#000; /* whole background black */
  font-size:14px;
}

.layout {
  display:grid;
  grid-template-columns:440px 1fr; /* wider sidebar on desktop */
  gap:16px;
  min-height:100vh;
  padding:16px;
  box-sizing:border-box;
}

/* Responsive: shrink sidebar for smaller screens */
@media (max-width:1200px){
  .layout {
    grid-template-columns:420px 1fr; /* back to default width */
  }
}

@media (max-width:900px){
  .layout {
    grid-template-columns:1fr; /* stack sidebar above map */
  }
}

/* Sidebar panels (filters + legend) WHITE */
.controls, .legend {
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:14px;
  color:#111;
  padding:14px;
  box-shadow:0 2px 8px rgba(0,0,0,.08);
}

/* Add space below filters panel */
.controls { margin-bottom: 16px; }

/* Headers: hot pink */
.controls label,
.legend-header {
  color: var(--hotpink);
  font-weight: 800;
  font-size: 18px;
  line-height: 1.2;
}

/* Row spacing inside the filters panel */
.controls .row { margin-bottom: 16px; }
.controls .row:last-child { margin-bottom: 0; }

.row-inline{display:flex;align-items:center;justify-content:space-between;gap:8px}

/* Search input */
#search {
  width:100%;
  padding:10px;
  border:1px solid #d1d5db;
  border-radius:10px;
  background:#fff;
  color:#111;
  font-family:"Raleway",sans-serif;
}

/* Chips (practice areas): hot pink bg, WHITE text; invert on active */
.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip {
  border: 1px solid var(--hotpink-border);
  background: var(--hotpink);
  color: #FFFFFF;               /* white text */
  border-radius: 999px;
  padding: 6px 10px;
  cursor: pointer;
  font-size: 13px;
  font-family: "Raleway", sans-serif;
}
.chip.active {
  background: #fff;          /* invert when active */
  border-color: var(--hotpink);
  color: var(--hotpink);
  font-weight: 600;
}
#category-filters {
  margin-bottom: 16px; /* space beneath chips */
}
/* Clear button (outlined hot pink) */
.btn-clear {
  border: 1px solid var(--hotpink);
  background: #fff;
  color: var(--hotpink);
  border-radius: 999px;
  padding: 6px 10px;
  font-size: 12px;
  cursor: pointer;
  font-family: "Raleway", sans-serif;
}
.btn-clear:hover { background:#f3f4f6; }

/* Legend */
.legend{
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:14px;
  overflow:auto;
  min-height:50vh;
  color:#111;
}
.legend-header {
  padding:10px 12px;
  border-bottom:1px solid var(--hotpink);
}
.legend-list .item {
  padding:10px 12px;
  border-bottom:1px solid #e5e7eb;
  cursor:pointer;
}
.legend-list .item:last-child{border-bottom:none}

/* Partner names black by default, hot pink when active */
.legend-list h4 {
  margin:0;
  font-size:14px;
  line-height:1.25;
  color:#111;
  font-family:"Raleway",sans-serif;
}
.legend-list .item.active h4 {
  color:var(--hotpink);
  font-weight:700;
}
.legend-list .meta {
  font-size:12px;
  color:#555;
  font-family:"Raleway",sans-serif;
}

/* Right column: detail ABOVE map */
.stage{
.stage {
  display:grid;
  grid-template-rows:auto 1fr; /* detail auto-height, map fills remaining space */
  gap:12px;
  align-content:start;
}

/* Map box */
#map {
  border:1px solid #e5e7eb;
  border-radius:14px;
  height:100%;     /* fill the grid cell */
  background:#fff;
}

/* Grayscale tiles */
#map .leaflet-tile { filter: grayscale(100%) saturate(0) contrast(1.05); }

/* Detail panel (WHITE) */
.detail{
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:14px;
  padding:14px;
  position:relative;
  font-family:"Raleway",sans-serif;
  color:#111;
}
.detail h2{margin:0 0 6px 0;font-size:17px;color:#111}
.detail .kv{font-size:13px}
.kv b{font-weight:700}
.kv a{text-decoration:underline}
.section-title{margin-top:10px;font-weight:700;font-size:13px}

/* Category pills in description: hot pink bg + white text */
.pill{
  display:inline-block;
  background: var(--hotpink);
  color:#FFFFFF;                 /* white text */
  border-radius:999px;
  padding:2px 8px;
  font-size:11px;
  margin:2px 4px 0 0;
}

.detail-header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:4px}
.detail-close{border:none;background:#f3f4f6;border-radius:10px;font-size:18px;line-height:1;padding:4px 10px;cursor:pointer}
.detail-close:hover{background:#e5e7eb}
.detail .empty{color:var(--hotpink);font-weight:600}

/* Leaflet popup styling */
.leaflet-container .leaflet-popup-content{font-family:"Raleway",system-ui,sans-serif;font-size:13px}
.leaflet-container .leaflet-popup-content-wrapper{border-radius:10px}
.leaflet-container .leaflet-popup-tip{opacity:.95}

@media (max-width:720px){
  .layout{grid-template-columns:1fr}
  .stage{grid-template-rows:auto 360px}
}
</style>
</head>
<body>
<div class="layout">
  <aside class="sidebar">
    <div class="controls">
      <div class="row">
        <label>Search</label>
        <input id="search" type="text" placeholder="Search partners, services, or notes…"/>
      </div>
      <div class="row row-inline">
        <label style="margin:0">Practice Areas</label>
        <button id="clear-cats" class="btn-clear" type="button">Clear filters</button>
      </div>
      <div id="category-filters" class="chips"></div>
      <div class="row">
        <label>Sort by</label>
        <select id="sort">
          <option value="name">Name (A→Z)</option>
          <option value="primary">Main Practice Area (A→Z)</option>
          <option value="category">Practice Areas (A→Z)</option>
        </select>
      </div>
    </div>
    <div class="legend">
      <div class="legend-header"><span>Partners</span></div>
      <div id="list" class="legend-list" role="listbox" aria-label="Partner list"></div>
    </div>
  </aside>

  <main class="stage">
    <section id="detail" class="detail" aria-live="polite" aria-atomic="true">
      <div class="empty">Select a partner from the list of names to find out more!</div>
    </section>
    <div id="map"></div>
  </main>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
(function(){
  const CSV_URL='https://docs.google.com/spreadsheets/d/e/2PACX-1vR1A8WkC-BbA94Ipm6Sit3qx5ndFoTG-zBBqnZPkNDEvHa11O0BJTRCWepWyo6RhqH58ZK1kQXO9v6P/pub?gid=1272818494&single=true&output=csv';
  const TILE_URL='https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png';
  const ATTRIB='&copy; OpenStreetMap &copy; CARTO';
  const MARKER_STYLE={radius:6,weight:1.5,color:'var(--hotpink-border)',fillColor:'var(--hotpink)',fillOpacity:0.9};

  const FIELD_ALIASES={
    name:['_Name','Name'],address:['_Address','Address','Location','Street'],lat:['_Latitude','Latitude','Lat'],
    lng:['_Longitude','Longitude','Lng','Long'],website:['_Website','Website','URL'],
    description:['_Description','Description','Notes'],category:['_Category','Category','Main Practice areas','Main Practice Areas'],
    primary:['_PrimaryCategory','PrimaryCategory'],intake:['_Intake','Intake'],
    geoElig:['_GeographicEligibility','Geographic Eligibility'],finElig:['_FinancialEligibility','Financial Eligibility']
  };

  const els={search:document.getElementById('search'),sort:document.getElementById('sort'),
    cats:document.getElementById('category-filters'),clearCats:document.getElementById('clear-cats'),
    list:document.getElementById('list'),detail:document.getElementById('detail')};

  let data=[],filtered=[],activeId=null,currentBounds=null;
  const practiceAreas=new Set();

  // Map
  const map=L.map('map',{zoomControl:true,attributionControl:true});
  L.tileLayer(TILE_URL,{maxZoom:19,attribution:ATTRIB}).addTo(map);
  const layerGroup=L.layerGroup().addTo(map);
  const markers=[];

  // Header mapping helpers (case/space-insensitive)
  let headerMap={};
  function buildHeaderMap(fields){
    headerMap={};
    (fields||[]).forEach(h=>{
      if(!h) return;
      headerMap[h]=h;
      headerMap[String(h).toLowerCase()]=h;
      headerMap[String(h).trim().toLowerCase()]=h;
    });
  }
  function pick(row, keys){
    for(const k of keys){
      if(row[k]!==undefined && String(row[k]).trim()!=='') return String(row[k]).trim();
      const norm=String(k||'').trim().toLowerCase();
      const real=headerMap[norm];
      if(real && row[real]!==undefined && String(row[real]).trim()!=='') return String(row[real]).trim();
    }
    return '';
  }
  const splitCats = s => (s||'').split(/[,;]/).map(v=>v.trim()).filter(Boolean);

  function popupHTML(r){
    const name=pick(r,FIELD_ALIASES.name)||'Untitled';
    const addr=pick(r,FIELD_ALIASES.address);
    const site=pick(r,FIELD_ALIASES.website);
    const cats=splitCats(pick(r,FIELD_ALIASES.category));
    const addrHtml=addr?`<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}" target="_blank" rel="noopener">${addr}</a>`:'';
    return `<div style="font-family:'Raleway';font-size:13px">
      <div style="font-weight:600">${name}</div>
      ${addrHtml?`<div>${addrHtml}</div>`:''}
      ${cats.length?`<div style="color:#6b7280;font-size:12px">${cats.join(', ')}</div>`:''}
      ${site?`<a href="${site}" target="_blank" rel="noopener">website</a>`:''}
    </div>`;
  }

  function boundsFromRows(rows){
    const b=L.latLngBounds([]);
    rows.forEach(r=>{
      const lat=parseFloat(pick(r,FIELD_ALIASES.lat));
      const lng=parseFloat(pick(r,FIELD_ALIASES.lng));
      if(!isNaN(lat)&&!isNaN(lng)) b.extend([lat,lng]);
    });
    return b.isValid()? b : L.latLngBounds([[41.85,-87.75],[42.05,-87.55]]);
  }

  function renderCategories(){
    els.cats.innerHTML='';
    Array.from(practiceAreas).sort((a,b)=>a.localeCompare(b)).forEach(cat=>{
      const span=document.createElement('span');
      span.className='chip'; // start cleared
      span.textContent=cat; span.dataset.value=cat;
      span.onclick=()=>{span.classList.toggle('active');applyFilters();};
      els.cats.appendChild(span);
    });
  }

  function clearCategoryFilters(){
    els.cats.querySelectorAll('.chip.active').forEach(ch=>ch.classList.remove('active'));
    applyFilters();
  }

  function renderMarkers(rows){
    layerGroup.clearLayers();markers.length=0;
    rows.forEach(r=>{
      const lat=parseFloat(pick(r,FIELD_ALIASES.lat));
      const lng=parseFloat(pick(r,FIELD_ALIASES.lng));
      if(isNaN(lat)||isNaN(lng))return;
      const m=L.circleMarker([lat,lng],MARKER_STYLE);
      m.__id=r.__id;
      m.bindPopup(popupHTML(r),{maxWidth:300,autoPan:true,autoPanPadding:[30,30]});
      m.on('click',()=>{selectById(r.__id,true);map.once('moveend',()=>m.openPopup());m.openPopup();});
      m.on('popupclose',()=>{
        if(activeId===m.__id){
          activeId=null;
          renderDetail(null);
          document.querySelectorAll('.legend-list .item').forEach(el=>el.classList.remove('active'));
        }
        if(currentBounds) map.fitBounds(currentBounds,{padding:[20,20]});
      });
      markers.push(m);layerGroup.addLayer(m);
    });
    currentBounds=boundsFromRows(rows);
    map.fitBounds(currentBounds,{padding:[20,20]});
  }

  function renderList(rows){
    els.list.innerHTML=rows.map(r=>{
      const id=r.__id;const name=pick(r,FIELD_ALIASES.name)||'Untitled';
      const primary=pick(r,FIELD_ALIASES.primary)||(splitCats(pick(r,FIELD_ALIASES.category))[0]||'');
      return `<div class="item${activeId===id?' active':''}" data-id="${id}" role="option" tabindex="0">
        <h4>${name}</h4>
        <div class="meta">${primary||''}</div>
      </div>`;
    }).join('');
    els.list.querySelectorAll('.item').forEach(el=>{
      el.addEventListener('click',()=>{
        const id=Number(el.dataset.id);
        selectById(id,true);
        const m=markers.find(mm=>mm.__id===id);
        if(m){map.once('moveend',()=>m.openPopup());m.openPopup();}
      });
      el.addEventListener('keydown',e=>{
        if(e.key==='Enter'||e.key===' '){
          e.preventDefault();
          const id=Number(el.dataset.id);
          selectById(id,true);
          const m=markers.find(mm=>mm.__id===id);
          if(m){map.once('moveend',()=>m.openPopup());m.openPopup();}
        }
      });
    });
  }

  function renderDetail(r){
    if(!r){
      els.detail.innerHTML='<div class="empty">Select a partner from the list of names to find out more!</div>';
      return;
    }
    const name=pick(r,FIELD_ALIASES.name)||'Untitled';
    const addr=pick(r,FIELD_ALIASES.address);
    const site=pick(r,FIELD_ALIASES.website);
    const desc=pick(r,FIELD_ALIASES.description);
    const cats=splitCats(pick(r,FIELD_ALIASES.category));
    const primary=pick(r,FIELD_ALIASES.primary)||(cats[0]||'');
    const intake=pick(r,FIELD_ALIASES.intake);
    const geo=pick(r,FIELD_ALIASES.geoElig);
    const fin=pick(r,FIELD_ALIASES.finElig);
    const addrHtml=addr?`<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}" target="_blank" rel="noopener">${addr}</a>`:'';

    els.detail.innerHTML=`
      <div class="detail-header">
        <h2>${name}</h2>
        <button class="detail-close" id="detail-close" aria-label="Close">×</button>
      </div>
      ${primary?`<div class="kv"><b>Main Practice Area:</b> ${primary}</div>`:''}
      ${cats.length?`<div>${cats.map(c=>`<span class="pill">${c}</span>`).join('')}</div>`:''}
      ${addrHtml?`<div class="kv"><b>Address:</b> ${addrHtml}</div>`:''}
      ${site?`<div class="kv"><b>Website:</b> <a href="${site}" target="_blank" rel="noopener">${site}</a></div>`:''}
      ${desc?`<div class="section-title">About</div><div>${desc}</div>`:''}
      ${intake?`<div class="section-title">Intake</div><div>${intake}</div>`:''}
      ${geo?`<div class="section-title">Geographic Eligibility</div><div>${geo}</div>`:''}
      ${fin?`<div class="section-title">Financial Eligibility</div><div>${fin}</div>`:''}
    `;

    const closeBtn=document.getElementById('detail-close');
    if(closeBtn){
      closeBtn.addEventListener('click',()=>{
        activeId=null;
        els.detail.innerHTML='<div class="empty">Select a partner from the list of names to find out more!</div>';
        markers.forEach(m=>m.closePopup());
        if(currentBounds) map.fitBounds(currentBounds,{padding:[20,20]});
        els.list.querySelectorAll('.item').forEach(el=>el.classList.remove('active'));
      });
    }
  }

  function selectById(id,moveMap){
    activeId=id;
    const row=filtered.find(r=>r.__id===activeId);
    if(!row) return;
    renderDetail(row);
    els.list.querySelectorAll('.item').forEach(el=>el.classList.toggle('active', Number(el.dataset.id)===activeId));
    if(moveMap){
      const lat=parseFloat(pick(row,FIELD_ALIASES.lat));
      const lng=parseFloat(pick(row,FIELD_ALIASES.lng));
      if(!isNaN(lat)&&!isNaN(lng)){
        map.setView([lat,lng], Math.max(map.getZoom(), 14), {animate:true, duration:0.35});
      }
    }
  }

  function applyFilters(){
    const q=(els.search.value||'').toLowerCase();
    const activeCats=Array.from(els.cats.querySelectorAll('.chip.active')).map(x=>x.dataset.value);
    const sortBy=els.sort.value;

    filtered=data.filter(r=>{
      const cats=splitCats(pick(r,FIELD_ALIASES.category));
      const inCat=activeCats.length?cats.some(c=>activeCats.includes(c)):true;
      const hay=[
        pick(r,FIELD_ALIASES.name),
        pick(r,FIELD_ALIASES.address),
        pick(r,FIELD_ALIASES.description),
        pick(r,FIELD_ALIASES.category),
        pick(r,FIELD_ALIASES.intake),
        pick(r,FIELD_ALIASES.geoElig),
        pick(r,FIELD_ALIASES.finElig)
      ].filter(Boolean).join(' ').toLowerCase();
      const inSearch=q?hay.includes(q):true;
      return inCat && inSearch;
    });

    filtered.sort((a,b)=>{
      if(sortBy==='primary'){
        const pa=pick(a,FIELD_ALIASES.primary)||(splitCats(pick(a,FIELD_ALIASES.category))[0]||'');
        const pb=pick(b,FIELD_ALIASES.primary)||(splitCats(pick(b,FIELD_ALIASES.category))[0]||'');
        return pa.localeCompare(pb);
      }
      if(sortBy==='category'){
        return pick(a,FIELD_ALIASES.category).localeCompare(pick(b,FIELD_ALIASES.category));
      }
      return pick(a,FIELD_ALIASES.name).localeCompare(pick(b,FIELD_ALIASES.name));
    });

    renderMarkers(filtered);
    renderList(filtered);

    if(!filtered.find(r=>r.__id===activeId)){
      activeId=null;
      renderDetail(null);
      els.list.querySelectorAll('.item').forEach(el=>el.classList.remove('active'));
    }
  }

  // Load CSV and initialize
  Papa.parse(CSV_URL,{
    download:true,header:true,skipEmptyLines:true,
    complete:res=>{
      const fields = (res.meta && res.meta.fields) || [];
      // build header map for flexible column names
      buildHeaderMap(fields);

      data=res.data.map((r,idx)=>{
        const cats=splitCats(pick(r,FIELD_ALIASES.category));
        cats.forEach(c=>practiceAreas.add(c));
        return Object.assign({},r,{__id:idx+1});
      });

      renderCategories();
      applyFilters();

      // listeners
      els.search.addEventListener('input',applyFilters);
      els.sort.addEventListener('change',applyFilters);
      els.clearCats.addEventListener('click',clearCategoryFilters);
    },
    error:err=>{
      console.error('CSV load error',err);
      els.detail.innerHTML='<div style="color:#b91c1c">CSV could not be loaded. Make sure the Google Sheet is “Published to the web”.</div>';
    }
  });
})();
</script>
</body>
</html>
