<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>All Partners Map</title>

<!-- Raleway font + Leaflet -->
<link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>

<style>
:root{
  --hotpink: hsla(323, 98%, 49%, 0.9);
  --hotpink-border: hsla(323, 98%, 35%, 1);
}

html, body { height: 100%; margin: 0; }
body{
  font-family:"Raleway",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  background:#000;
  color:#111;
  font-size:14px;
  overflow:hidden; /* keep page from scrolling; panels/map manage their own scroll */
}

/* Overall layout */
.layout {
  display:grid;
  grid-template-rows: auto 1fr;
  height:100vh;
  padding:16px;
  box-sizing:border-box;
}
.stage {
  display:grid;
  grid-template-rows:auto 1fr; /* top panels (short) then tall map */
  gap:12px;
}

/* Map is taller because top panels are compact */
#map{
  border:1px solid #e5e7eb;
  border-radius:14px;
  background:#fff;
  width:100%;
  height:calc(100vh - 340px); /* adjust if you want more/less map height */
  min-height:360px;
}

/* Top panels row (short) */
.top-panels {
  display:grid;
  grid-template-columns: 260px 1fr;
  gap:16px;
  max-height:700px; /* compact height */
}

/* Cards */
.legend, .controls {
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:14px;
  box-shadow:0 2px 8px rgba(0,0,0,.08);
  padding:14px;
  overflow-y:auto; /* internal scroll if content is long */
}

/* Headings */
.legend-header, .controls label {
  color:var(--hotpink);
  font-weight:800;
}
.legend-header{
  border-bottom:1px solid var(--hotpink);
  padding-bottom:8px;
  margin-bottom:8px;
}

/* Language toggle row */
.row-top{
  display:flex;
  justify-content:flex-end;
  align-items:center;
  margin-bottom: 12px;
}

/* Language toggle pill */
.lang-toggle{
  border:1px solid var(--hotpink);
  background:#fff; color:var(--hotpink);
  border-radius:999px; padding:8px 16px;
  font-size:13px; cursor:pointer;
  font-family:"Raleway", sans-serif; font-weight:700;
}
.lang-toggle[aria-pressed="true"]{
  background:var(--hotpink); color:#fff; border-color:var(--hotpink);
}

/* Inputs */
#lbl-search { display:block; margin-bottom: 10px; }
#search{
  width:90%; /* shorter width, same height */
  padding:11px;
  border:1px solid #d1d5db;
  border-radius:10px;
  background:#fff; color:#111;
  font-family:"Raleway",sans-serif;
}

/* Sections inside controls */
.controls .row { margin-bottom: 12px; }
.row-inline{display:flex;align-items:center;justify-content:space-between;gap:8px}

/* Chips */
.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip {
  border:1px solid var(--hotpink-border);
  background:var(--hotpink);
  color:#FFFFFF;
  border-radius:999px;
  padding:6px 10px;
  cursor:pointer;
  font-size:13px;
  font-family:"Raleway",sans-serif;
}
.chip.active {
  background:#fff;
  border-color:var(--hotpink);
  color:var(--hotpink);
  font-weight:600;
}
.btn-clear {
  border:1px solid var(--hotpink);
  background:#fff;
  color:var(--hotpink);
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;
  cursor:pointer;
  font-family:"Raleway",sans-serif;
}
.btn-clear:hover { background:#f3f4f6; }

/* Partner list */
.legend-list .item{
  padding:8px 4px;
  border-bottom:1px solid #eee;
  cursor:pointer;
}
.legend-list .item:last-child{border-bottom:none}
.legend-list h4{margin:0;font-size:14px;color:#111;}
.legend-list .item.active h4{color:var(--hotpink);}
.legend-list .meta{display:none !important;} /* hide the subline */

/* Detail card */
.detail{
  background:#fff; border:1px solid #e5e7eb;
  border-radius:14px; padding:12px;
  color:#111;
}
.detail-header {
  display:flex; align-items:center; justify-content:space-between;
  gap:8px; margin-bottom:6px;
}
.detail-header .titlewrap {
  display:flex; align-items:center; gap:10px; flex:1; min-width:0;
}
.detail-logo {
  width:45px; height:45px; border-radius:8px; border:1px solid #e5e7eb;
  background:#fff; object-fit:contain; flex:0 0 auto;
}
.detail h2 {
  margin:0; font-size:18px; font-weight:700; color:#111;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.pill{
  display:inline-block;
  background:var(--hotpink);
  color:#FFFFFF;
  border-radius:999px;
  padding:2px 8px;
  font-size:11px;
  margin:2px 4px 0 0;
}
.detail-close{border:none;background:#f3f4f6;border-radius:10px;font-size:18px;padding:4px 10px;cursor:pointer;}
.detail-close:hover{background:#e5e7eb;}
.detail .empty{color:var(--hotpink);font-weight:600;}

/* Bold section headers (About, Intake, etc.) */
.section-title {
  margin-top:10px; font-weight:700; font-size:13px; color:#111;
}

/* Map tiles & markers */
#map .leaflet-tile{filter:grayscale(100%) saturate(0) contrast(1.05);}
.leaflet-marker-icon.partner-logo-icon{
  width:40px;height:40px;border-radius:50%;
  border:2px solid #fff;background:#fff;
  box-shadow:0 0 6px rgba(0,0,0,.25);object-fit:cover;
}

/* Smaller screens: stack panels */
@media(max-width:1000px){
  .top-panels{grid-template-columns:1fr;}
  #map{ height:50vh; }
}
</style>
</head>
<body>
<div class="layout">
  <main class="stage">
    <div class="top-panels">
      <!-- Partners list -->
      <aside class="legend">
        <div class="legend-header"><span id="lbl-partners">Partners</span></div>
        <div id="list" class="legend-list" role="listbox" aria-label="Partner list"></div>
      </aside>

      <!-- Filters + Description -->
      <section class="controls">
        <!-- Only the language toggle in this top row -->
        <div class="row-top">
          <button id="lang-toggle" class="lang-toggle" aria-pressed="false" title="Switch to Spanish">Español</button>
        </div>

        <div class="row">
          <label id="lbl-search">Search</label>
          <input id="search" type="text" placeholder="Search partners, services, or notes…"/>
        </div>

        <!-- Partner Program chips -->
        <div class="row">
          <div class="row-inline">
            <label id="lbl-program" style="margin:0">Partner Program</label>
            <button id="clear-programs" class="btn-clear" type="button">Clear</button>
          </div>
          <div id="program-filters" class="chips"></div>
        </div>

        <!-- Practice Area chips -->
        <div class="row">
          <div class="row-inline">
            <label id="lbl-practice" style="margin:0">Practice Areas</label>
            <button id="clear-cats" class="btn-clear" type="button">Clear</button>
          </div>
          <div id="category-filters" class="chips"></div>
        </div>

        <!-- Sort -->
        <div class="row">
          <label id="lbl-sort">Sort by</label>
          <select id="sort">
            <option value="name" id="opt-name">Name (A→Z)</option>
            <option value="primary" id="opt-primary">Main Practice Area (A→Z)</option>
            <option value="category" id="opt-category">Practice Areas (A→Z)</option>
          </select>
        </div>

        <!-- Detail -->
        <section id="detail" class="detail" aria-live="polite" aria-atomic="true">
          <div class="empty" id="empty-msg">Select a partner from the list of names to find out more!</div>
        </section>
      </section>
    </div>

    <!-- Map -->
    <div id="map"></div>
  </main>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
(function(){
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRB-p0cOJWyXf-m7THfqPJ-xwrLGoejBMbsXjQwIqQ2drm2dBC3WuyYaJCt0XmzCfV8E_qz67y6PpCl/pub?output=csv';
  const TILE_URL='https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png';
  const ATTRIB='&copy; OpenStreetMap &copy; CARTO';
  const MARKER_STYLE={radius:6,weight:1.5,color:'var(--hotpink-border)',fillColor:'var(--hotpink)',fillOpacity:0.9};

  /* Column aliases (EN) */
  const FIELD_ALIASES={
    name:['_Name','Name'],
    program:['_PartnerProgram','PartnerProgram'],
    address:['_Address','Address'],
    lat:['_Latitude','Latitude'],
    lng:['_Longitude','Longitude'],
    website:['_Website','Website'],
    description:['_Description','Description'],
    category:['_Category','Category','Main Practice areas','Main Practice Areas'],
    primary:['_PrimaryCategory','PrimaryCategory'],
    intake:['_Intake','Intake'],
    geoElig:['_GeographicEligibility','Geographic Eligibility'],
    finElig:['_FinancialEligibility','Financial Eligibility'],
    logo:['_Logo','Logo'],
    zips:['_ZipCodes','ZipCodes','Zip Codes']
  };
  /* Column aliases (ES) */
  const FIELD_ALIASES_ES={
    name:['_Name_es','Name_es'],
    program:['_PartnerProgram_es','PartnerProgram_es'],
    address:['_Address_es','Address_es'],
    description:['_Description_es','Description_es'],
    category:['_Category_es','Category_es'],
    intake:['_Intake_es','Intake_es'],
    geoElig:['_GeographicEligibility_es','GeographicEligibility_es','Geographic Eligibility_es'],
    finElig:['_FinancialEligibility_es','FinancialEligibility_es','Financial Eligibility_es']
  };

  /* UI strings */
  const i18n={
    en:{
      partners:'Partners',
      search:'Search',
      searchPH:'Search partners, services, or notes…',
      program:'Partner Program',
      clear:'Clear',
      practice:'Practice Areas',
      sortBy:'Sort by',
      optName:'Name (A→Z)',
      optPrimary:'Main Practice Area (A→Z)',
      optCategory:'Practice Areas (A→Z)',
      empty:'Select a partner from the list of names to find out more!',
      address:'Address',website:'website',websiteLabel:'Website',about:'About',
      intake:'Intake',geo:'Geographic Eligibility',fin:'Financial Eligibility',
      toggleTitle:'Switch to Spanish', toggleBtnNext:'Español'
    },
    es:{
      partners:'Socios',
      search:'Buscar',
      searchPH:'Buscar organizaciones, servicios o notas…',
      program:'Tipo de colaboración',
      clear:'Borrar',
      practice:'Áreas de práctica',
      sortBy:'Ordenar por',
      optName:'Nombre (A→Z)',
      optPrimary:'Área principal (A→Z)',
      optCategory:'Áreas de práctica (A→Z)',
      empty:'¡Selecciona una organización de la lista para ver más información!',
      address:'Dirección',website:'sitio web',websiteLabel:'Sitio web',about:'Acerca de',
      intake:'Admisión',geo:'Elegibilidad geográfica',fin:'Elegibilidad financiera',
      toggleTitle:'Cambiar a inglés', toggleBtnNext:'English'
    }
  };

  /* Elements */
  const els={
    langBtn:document.getElementById('lang-toggle'),
    lblPartners:document.getElementById('lbl-partners'),
    lblSearch:document.getElementById('lbl-search'),
    search:document.getElementById('search'),

    lblProgram:document.getElementById('lbl-program'),
    clearPrograms:document.getElementById('clear-programs'),
    programChips:document.getElementById('program-filters'),

    lblPractice:document.getElementById('lbl-practice'),
    clearCats:document.getElementById('clear-cats'),
    catChips:document.getElementById('category-filters'),

    lblSort:document.getElementById('lbl-sort'),
    sort:document.getElementById('sort'),
    optName:document.getElementById('opt-name'),
    optPrimary:document.getElementById('opt-primary'),
    optCategory:document.getElementById('opt-category'),

    list:document.getElementById('list'),
    detail:document.getElementById('detail'),
    emptyMsg:document.getElementById('empty-msg')
  };

  /* State */
  let currentLang='en';
  let headerMap={};
  let data=[], filtered=[], activeId=null, currentBounds=null;
  const map=L.map('map',{zoomControl:true,attributionControl:true});
  L.tileLayer(TILE_URL,{maxZoom:19,attribution:ATTRIB}).addTo(map);
  const layerGroup=L.layerGroup().addTo(map);
  const markers=[];

  /* Header helpers */
  function buildHeaderMap(fields){
    headerMap={};
    (fields||[]).forEach(h=>{
      if(!h) return;
      headerMap[h]=h;
      headerMap[String(h).toLowerCase()]=h;
      headerMap[String(h).trim().toLowerCase()]=h;
    });
  }
  function pick(row,keys){
    for(const k of keys){
      if(row[k]!==undefined && String(row[k]).trim()!=='') return String(row[k]).trim();
      const norm=String(k||'').trim().toLowerCase();
      const real=headerMap[norm];
      if(real && row[real]!==undefined && String(row[real]).trim()!=='') return String(row[real]).trim();
    }
    return '';
  }
  function pickLang(row,key){
    if(currentLang==='es' && FIELD_ALIASES_ES[key]){
      const vEs=pick(row,FIELD_ALIASES_ES[key]);
      if(vEs) return vEs;
    }
    return pick(row,FIELD_ALIASES[key]||[]);
  }
  const splitList = s => (s||'').split(/[,;]+/).map(v=>v.trim()).filter(Boolean);

  /* i18n swap */
  function setLang(lang){
    currentLang = lang;
    const t = i18n[lang];
    document.documentElement.setAttribute('lang', lang);

    els.lblPartners.textContent = t.partners;
    els.lblSearch.textContent = t.search;
    els.search.placeholder = t.searchPH;

    els.lblProgram.textContent = t.program;
    els.clearPrograms.textContent = t.clear;

    els.lblPractice.textContent = t.practice;
    els.clearCats.textContent = t.clear;

    els.lblSort.textContent = t.sortBy;
    els.optName.textContent = t.optName;
    els.optPrimary.textContent = t.optPrimary;
    els.optCategory.textContent = t.optCategory;

    if(els.langBtn){
      const pressed=(lang==='es');
      els.langBtn.setAttribute('aria-pressed', pressed ? 'true' : 'false');
      els.langBtn.textContent = pressed ? i18n.es.toggleBtnNext : i18n.en.toggleBtnNext;
      els.langBtn.title = t.toggleTitle;
    }

    /* rebuild chips per language and refresh view */
    renderProgramChips();
    renderCategoryChips();
    applyFilters();

    if(activeId){
      const row=filtered.find(r=>r.__id===activeId);
      if(row) renderDetail(row); else renderDetail(null);
    } else {
      renderDetail(null);
    }
  }

  /* Map helpers */
  function popupHTML(r){
    const t = i18n[currentLang];
    const name=pickLang(r,'name')||'Untitled';
    const addr=pickLang(r,'address');
    const site=pick(r,FIELD_ALIASES.website);
    const cats=splitList(pickLang(r,'category'));
    const addrHtml=addr?`<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}" target="_blank" rel="noopener">${addr}</a>`:'';
    return `<div style="font-family:'Raleway';font-size:13px">
      <div style="font-weight:600">${name}</div>
      ${addrHtml?`<div><b>${t.address}:</b> ${addrHtml}</div>`:''}
      ${cats.length?`<div style="color:#6b7280;font-size:12px">${cats.join(', ')}</div>`:''}
      ${site?`<a href="${site}" target="_blank" rel="noopener">${t.website}</a>`:''}
    </div>`;
  }
  function boundsFromRows(rows){
    const b=L.latLngBounds([]);
    rows.forEach(r=>{
      const lat=parseFloat(pick(r,FIELD_ALIASES.lat));
      const lng=parseFloat(pick(r,FIELD_ALIASES.lng));
      if(!isNaN(lat)&&!isNaN(lng)) b.extend([lat,lng]);
    });
    return b.isValid()? b : L.latLngBounds([[41.85,-87.75],[42.05,-87.55]]);
  }

  /* Chips renderers */
  function renderProgramChips(){
    const set=new Set();
    data.forEach(r => splitList(pickLang(r,'program')).forEach(v => set.add(v)));
    const arr=[...set].sort((a,b)=>a.localeCompare(b));
    els.programChips.innerHTML='';
    arr.forEach(val=>{
      const span=document.createElement('span');
      span.className='chip';
      span.textContent=val;
      span.dataset.value=val;
      span.onclick=()=>{ span.classList.toggle('active'); applyFilters(); };
      els.programChips.appendChild(span);
    });
  }
  function renderCategoryChips(){
    const set=new Set();
    data.forEach(r => splitList(pickLang(r,'category')).forEach(v => set.add(v)));
    const arr=[...set].sort((a,b)=>a.localeCompare(b));
    els.catChips.innerHTML='';
    arr.forEach(val=>{
      const span=document.createElement('span');
      span.className='chip';
      span.textContent=val;
      span.dataset.value=val;
      span.onclick=()=>{ span.classList.toggle('active'); applyFilters(); };
      els.catChips.appendChild(span);
    });
  }

  /* Renderers */
  function renderMarkers(rows){
    layerGroup.clearLayers(); markers.length=0;
    rows.forEach(r=>{
      const lat=parseFloat(pick(r,FIELD_ALIASES.lat));
      const lng=parseFloat(pick(r,FIELD_ALIASES.lng));
      if(isNaN(lat)||isNaN(lng))return;

      const logo=pick(r,FIELD_ALIASES.logo);
      let m;
      if(logo){
        const icon=L.icon({iconUrl:logo,iconSize:[40,40],iconAnchor:[20,40],popupAnchor:[0,-38],className:'partner-logo-icon'});
        m=L.marker([lat,lng],{icon});
      } else {
        m=L.circleMarker([lat,lng],MARKER_STYLE);
      }

      m.__id=r.__id;
      m.bindPopup(()=>popupHTML(r),{maxWidth:300,autoPan:true,autoPanPadding:[30,30]});
      m.on('click',()=>{selectById(r.__id,true);});
      m.on('popupclose',()=>{
        if(activeId===m.__id){
          activeId=null;
          renderDetail(null);
          document.querySelectorAll('.legend-list .item').forEach(el=>el.classList.remove('active'));
        }
        if(currentBounds) map.fitBounds(currentBounds,{padding:[20,20]});
      });

      markers.push(m); layerGroup.addLayer(m);
    });
    currentBounds=boundsFromRows(rows);
    map.fitBounds(currentBounds,{padding:[20,20]});
  }

  function renderList(rows){
    els.list.innerHTML=rows.map(r=>{
      const id=r.__id; const name=pickLang(r,'name')||'Untitled';
      return `<div class="item${activeId===id?' active':''}" data-id="${id}" role="option" tabindex="0">
        <h4>${name}</h4>
        <div class="meta"></div>
      </div>`;
    }).join('');
    els.list.querySelectorAll('.item').forEach(el=>{
      el.addEventListener('click',()=>{
        const id=Number(el.dataset.id);
        selectById(id,true);
        const m=markers.find(mm=>mm.__id===id);
        if(m){ map.once('moveend',()=>m.openPopup()); m.openPopup(); }
      });
      el.addEventListener('keydown',e=>{
        if(e.key==='Enter'||e.key===' '){
          e.preventDefault();
          const id=Number(el.dataset.id);
          selectById(id,true);
          const m=markers.find(mm=>mm.__id===id);
          if(m){ map.once('moveend',()=>m.openPopup()); m.openPopup(); }
        }
      });
    });
  }

  function renderDetail(r){
    const t = i18n[currentLang];
    if(!r){ els.detail.innerHTML=`<div class="empty">${t.empty}</div>`; return; }

    const name=pickLang(r,'name')||'Untitled';
    const logo=pick(r,FIELD_ALIASES.logo);
    const addr=pickLang(r,'address');
    const site=pick(r,FIELD_ALIASES.website);
    const desc=pickLang(r,'description');
    const cats=splitList(pickLang(r,'category'));
    const intake=pickLang(r,'intake');
    const geo=pickLang(r,'geoElig');
    const fin=pickLang(r,'finElig');
    const addrHtml=addr?`<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}" target="_blank" rel="noopener">${addr}</a>`:'';

    els.detail.innerHTML=`
      <div class="detail-header">
        <div class="titlewrap">
          ${logo ? `<img class="detail-logo" src="${logo}" alt="${name} logo" loading="lazy">` : ``}
          <h2>${name}</h2>
        </div>
        <button class="detail-close" id="detail-close" aria-label="Close">×</button>
      </div>
      ${cats.length?`<div>${cats.map(c=>`<span class="pill">${c}</span>`).join('')}</div>`:''}
      ${addrHtml?`<div class="kv"><b>${t.address}:</b> ${addrHtml}</div>`:''}
      ${site?`<div class="kv"><b>${t.websiteLabel}:</b> <a href="${site}" target="_blank" rel="noopener">${site}</a></div>`:''}
      ${desc?  `<div class="section-title"><strong>${t.about}</strong></div><div>${desc}</div>` : '' }
      ${intake?`<div class="section-title"><strong>${t.intake}</strong></div><div>${intake}</div>` : '' }
      ${geo?   `<div class="section-title"><strong>${t.geo}</strong></div><div>${geo}</div>` : '' }
      ${fin?   `<div class="section-title"><strong>${t.fin}</strong></div><div>${fin}</div>` : '' }
    `;

    const closeBtn=document.getElementById('detail-close');
    if(closeBtn){
      closeBtn.addEventListener('click',()=>{
        activeId=null;
        els.detail.innerHTML=`<div class="empty">${t.empty}</div>`;
        markers.forEach(m=>m.closePopup());
        if(currentBounds) map.fitBounds(currentBounds,{padding:[20,20]});
        document.querySelectorAll('.legend-list .item').forEach(el=>el.classList.remove('active'));
      });
    }
  }

  /* Selection */
  function selectById(id,moveMap){
    activeId=id;
    const row=filtered.find(r=>r.__id===activeId);
    if(!row) return;
    renderDetail(row);
    document.querySelectorAll('.legend-list .item').forEach(el=>el.classList.toggle('active', Number(el.dataset.id)===activeId));
    if(moveMap){
      const lat=parseFloat(pick(row,FIELD_ALIASES.lat));
      const lng=parseFloat(pick(row,FIELD_ALIASES.lng));
      if(!isNaN(lat)&&!isNaN(lng)){
        map.setView([lat,lng], Math.max(map.getZoom(), 14), {animate:true, duration:0.35});
      }
    }
  }

  /* Filtering / searching / sorting */
  function applyFilters(){
    const q=(els.search.value||'').toLowerCase();
    const activePrograms=[...els.programChips.querySelectorAll('.chip.active')].map(x=>x.dataset.value);
    const activeCats=[...els.catChips.querySelectorAll('.chip.active')].map(x=>x.dataset.value);
    const sortBy=els.sort.value;

    filtered=data.filter(r=>{
      const programs = splitList(pickLang(r,'program'));
      const categories = splitList(pickLang(r,'category'));

      const inProgram = activePrograms.length ? programs.some(p => activePrograms.includes(p)) : true;
      const inCategory = activeCats.length ? categories.some(c => activeCats.includes(c)) : true;

      const hay=[
        pickLang(r,'name'),
        pickLang(r,'address'),
        pickLang(r,'description'),
        pickLang(r,'category'),
        pickLang(r,'intake'),
        pickLang(r,'geoElig'),
        pickLang(r,'finElig'),
        pickLang(r,'program')
      ].filter(Boolean).join(' ').toLowerCase();
      const inSearch = q ? hay.includes(q) : true;

      return inProgram && inCategory && inSearch;
    });

    filtered.sort((a,b)=>{
      if(sortBy==='primary'){
        const pa=(splitList(pickLang(a,'category'))[0]||'');
        const pb=(splitList(pickLang(b,'category'))[0]||'');
        return pa.localeCompare(pb);
      }
      if(sortBy==='category'){
        return pickLang(a,'category').localeCompare(pickLang(b,'category'));
      }
      return pickLang(a,'name').localeCompare(pickLang(b,'name'));
    });

    renderMarkers(filtered);
    renderList(filtered);

    if(!filtered.find(r=>r.__id===activeId)){
      activeId=null;
      renderDetail(null);
      document.querySelectorAll('.legend-list .item').forEach(el=>el.classList.remove('active'));
    }
  }

  /* Load CSV */
  Papa.parse(CSV_URL,{
    download:true,header:true,skipEmptyLines:true,
    complete:res=>{
      const fields=(res.meta && res.meta.fields)||[];
      buildHeaderMap(fields);
      data=res.data.map((r,idx)=>Object.assign({},r,{__id:idx+1}));

      renderProgramChips();
      renderCategoryChips();
      applyFilters();

      /* listeners */
      els.search.addEventListener('input',applyFilters);
      els.sort.addEventListener('change',applyFilters);

      els.clearPrograms.addEventListener('click', ()=>{
        els.programChips.querySelectorAll('.chip.active').forEach(ch=>ch.classList.remove('active'));
        applyFilters();
      });
      els.clearCats.addEventListener('click',()=>{
        els.catChips.querySelectorAll('.chip.active').forEach(ch=>ch.classList.remove('active'));
        applyFilters();
      });

      if(els.langBtn){
        els.langBtn.addEventListener('click', ()=>{
          setLang(currentLang==='en' ? 'es' : 'en');
        });
      }
    },
    error:err=>{
      console.error('CSV load error',err);
      els.detail.innerHTML='<div style="color:#b91c1c">CSV could not be loaded. Make sure the Google Sheet is “Published to the web”.</div>';
    }
  });

  /* Init */
  setLang('en');
})();
</script>
</body>
</html>
