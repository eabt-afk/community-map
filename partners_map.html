<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Partners Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
<style>
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f8fafc}
  .legend-layout{display:grid;grid-template-columns:360px 1fr;gap:16px;min-height:100vh;padding:16px;box-sizing:border-box}
  .sidebar{display:flex;flex-direction:column;gap:12px}
  .controls{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
  .controls .row{margin-bottom:12px}
  .controls label{display:block;font-weight:600;margin-bottom:6px;font-size:14px}
  #search{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1px solid #d1d5db;border-radius:999px;padding:6px 10px;cursor:pointer;font-size:13px;user-select:none;background:#fff}
  .chip.active{background:#111827;color:#fff;border-color:#111827}
  .legend{background:#fff;border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;display:flex;flex-direction:column;height:100%}
  .legend-header{padding:10px 12px;font-weight:700;border-bottom:1px solid #f3f4f6;display:flex;justify-content:space-between;align-items:center}
  .legend-list{overflow:auto;max-height:50vh}
  .legend-item{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid #f3f4f6;cursor:pointer}
  .legend-item:last-child{border-bottom:none}
  .legend-item h4{margin:0;font-size:14px;line-height:1.25}
  .legend-item .meta{font-size:12px;color:#6b7280}
  .legend-item.active{background:#eef2ff}
  .stage{display:grid;grid-template-rows:minmax(420px,55vh) auto;gap:12px}
  #map{border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;height:100%}
  .detail{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px}
  .detail h2{margin:0 0 6px 0;font-size:18px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .kv{font-size:14px}
  .kv b{display:inline-block;min-width:160px}
  .section-title{margin-top:10px;font-weight:700}
  .pill{display:inline-block;background:#111827;color:#fff;border-radius:999px;padding:2px 8px;font-size:12px;margin:2px 4px 0 0}
  .empty{color:#6b7280}
  @media(max-width:980px){
    .legend-layout{grid-template-columns:1fr}
    .legend-list{max-height:none}
    .stage{grid-template-rows:360px auto}
  }
</style>
</head>
<body>
<div id="map-app" class="legend-layout">
  <aside class="sidebar">
    <div class="controls">
      <div class="row">
        <label>Search</label>
        <input id="search" type="text" placeholder="Search partners, services, or notes…"/>
      </div>
      <div class="row">
        <label>Practice Areas</label>
        <div id="category-filters" class="chips"></div>
      </div>
      <div class="row">
        <label>Sort by</label>
        <select id="sort">
          <option value="name">Name (A→Z)</option>
          <option value="primary">Main Practice Area (A→Z)</option>
          <option value="neighborhood">Neighborhood</option>
        </select>
      </div>
    </div>
    <div class="legend">
      <div class="legend-header"><span>Partners</span></div>
      <div id="list" class="legend-list" role="listbox" aria-label="Partner list"></div>
    </div>
  </aside>
  <main class="stage">
    <div id="map"></div>
    <section id="detail" class="detail" aria-live="polite" aria-atomic="true">
      <div class="empty">Select a partner from the list or map to see details.</div>
    </section>
  </main>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
(function(){
  // Your Google Sheets CSV URL
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR1A8WkC-BbA94Ipm6Sit3qx5ndFoTG-zBBqnZPkNDEvHa11O0BJTRCWepWyo6RhqH58ZK1kQXO9v6P/pub?gid=1272818494&single=true&output=csv';

  // Minimal basemap without labels
  const TILE_URL = 'https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png';
  const ATTRIB = '&copy; OpenStreetMap &copy; CARTO';

  const FIELD_ALIASES = {
    name: ['_Name','Name','Organization','Agency','Clinic','Firm','Program'],
    address: ['_Address','Address','Location','Street'],
    lat: ['_Latitude','Latitude','Lat'],
    lng: ['_Longitude','Longitude','Lng','Long'],
    website: ['_Website','Website','URL','Link','Site'],
    phone: ['_Phone','Phone','Telephone','Tel','Contact Phone'],
    neighborhood: ['_Neighborhood','Neighborhood','Community Area','Area'],
    description: ['_Description','Description','Notes','About','Services'],
    category: ['_Category','Category','Practice Areas','Areas of Practice'],
    primary: ['_PrimaryCategory','PrimaryCategory'],
    intake: ['_Intake','Intake','Intake Process','How to Apply','How to Contact'],
    geoElig: ['_GeographicEligibility','Geographic Eligibility','Service Area','Geography','Counties','Zip Codes'],
    finElig: ['_FinancialEligibility','Financial Eligibility','Income Eligibility','Income Limits','Fee','Sliding Scale','Cost']
  };

  const els = {
    search: document.getElementById('search'),
    sort: document.getElementById('sort'),
    cats: document.getElementById('category-filters'),
    list: document.getElementById('list'),
    detail: document.getElementById('detail')
  };

  const slug = s => (s||'').toString().toLowerCase();
  const splitCats = s => (s||'').split(',').map(v=>v.trim()).filter(Boolean);
  function pick(row, keys){ for (const k of keys){ if (row[k] !== undefined && String(row[k]).trim() !== '') return String(row[k]).trim(); } return ''; }

  let headers = [];
  let data = [];
  let filtered = [];
  const practiceAreas = new Set();

  // Map init
  const map = L.map('map', { zoomControl: true, attributionControl: true });
  L.tileLayer(TILE_URL, { maxZoom: 19, attribution: ATTRIB }).addTo(map);
  const layerGroup = L.layerGroup().addTo(map);
  const markers = [];
  let activeId = null;

  function boundsFromRows(rows){
    const b = L.latLngBounds([]);
    rows.forEach(r=>{
      const lat = parseFloat(pick(r, FIELD_ALIASES.lat));
      const lng = parseFloat(pick(r, FIELD_ALIASES.lng));
      if(!isNaN(lat)&&!isNaN(lng)) b.extend([lat,lng]);
    });
    return b.isValid()? b : L.latLngBounds([[41.85,-87.75],[42.05,-87.55]]);
  }

  function renderCategories(){
    els.cats.innerHTML = '';
    Array.from(practiceAreas).sort((a,b)=>a.localeCompare(b)).forEach(cat=>{
      const span = document.createElement('span');
      span.className = 'chip active';
      span.textContent = cat; span.dataset.value = cat;
      span.onclick = ()=>{ span.classList.toggle('active'); applyFilters(); };
      els.cats.appendChild(span);
    });
  }

  function renderList(rows){
    els.list.innerHTML = rows.map((r,i)=>{
      const id = r.__id;
      const name = pick(r, FIELD_ALIASES.name) || 'Untitled';
      const primary = pick(r, FIELD_ALIASES.primary);
      const neigh = pick(r, FIELD_ALIASES.neighborhood);
      const meta = [primary, neigh].filter(Boolean).join(' • ');
      return `<div class="legend-item${activeId===id?' active':''}" data-id="${id}" role="option" tabindex="0">
        <div>
          <h4>${name}</h4>
          <div class="meta">${meta}</div>
        </div>
      </div>`;
    }).join('');

    els.list.querySelectorAll('.legend-item').forEach(el=>{
      el.addEventListener('click', ()=> selectById(el.dataset.id, true));
      el.addEventListener('keydown', e=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); selectById(el.dataset.id, true);} });
    });
  }

  function renderDetail(row){
    if(!row){ els.detail.innerHTML = '<div class="empty">Select a partner from the list or map to see details.</div>'; return; }
    const name = pick(row, FIELD_ALIASES.name) || 'Untitled';
    const addr = pick(row, FIELD_ALIASES.address);
    const site = pick(row, FIELD_ALIASES.website);
    const phone = pick(row, FIELD_ALIASES.phone);
    const neigh = pick(row, FIELD_ALIASES.neighborhood);
    const desc = pick(row, FIELD_ALIASES.description);
    const cats = splitCats(pick(row, FIELD_ALIASES.category));
    const intake = pick(row, FIELD_ALIASES.intake);
    const geo = pick(row, FIELD_ALIASES.geoElig);
    const fin = pick(row, FIELD_ALIASES.finElig);

    // Other details from remaining headers
    const skip = new Set([].concat(...Object.values(FIELD_ALIASES)));
    const other = [];
    for (const h of headers){
      if (skip.has(h)) continue;
      const val = row[h];
      if (val !== undefined && String(val).trim() !== '') other.push(`<div class="kv"><b>${h}:</b> ${String(val).trim()}</div>`);
    }

    els.detail.innerHTML = `
      <h2>${name}</h2>
      ${cats.length? `<div>${cats.map(c=>`<span class="pill">${c}</span>`).join('')}</div>`:''}
      <div class="grid">
        ${addr? `<div class="kv"><b>Address:</b> ${addr}</div>`:''}
        ${neigh? `<div class="kv"><b>Neighborhood:</b> ${neigh}</div>`:''}
        ${phone? `<div class="kv"><b>Phone:</b> ${phone}</div>`:''}
        ${site? `<div class="kv"><b>Website:</b> <a href="${site}" target="_blank" rel="noopener">${site}</a></div>`:''}
      </div>
      ${desc? `<div class="section-title">About</div><div>${desc}</div>`:''}
      ${intake? `<div class="section-title">Intake</div><div>${intake}</div>`:''}
      ${geo? `<div class="section-title">Geographic Eligibility</div><div>${geo}</div>`:''}
      ${fin? `<div class="section-title">Financial Eligibility</div><div>${fin}</div>`:''}
      ${other.length? `<div class="section-title">Other details</div>${other.join('')}`:''}
    `;
  }

  function renderMarkers(rows){
    layerGroup.clearLayers();
    markers.length = 0;
    rows.forEach(r=>{
      const lat = parseFloat(pick(r, FIELD_ALIASES.lat));
      const lng = parseFloat(pick(r, FIELD_ALIASES.lng));
      if(isNaN(lat)||isNaN(lng)) return;
      const m = L.circleMarker([lat,lng], {radius:6, weight:1, color:'#111827', fillOpacity:0.8});
      m.__id = r.__id;
      m.on('click', ()=> selectById(r.__id, false));
      m.on('mouseover', ()=> m.setStyle({radius:7}));
      m.on('mouseout',  ()=> m.setStyle({radius:6}));
      markers.push(m);
      layerGroup.addLayer(m);
    });
    map.fitBounds(boundsFromRows(rows), {padding:[20,20]});
  }

  function selectById(id, fly){
    activeId = Number(id);
    const row = filtered.find(r=>r.__id===activeId);
    els.list.querySelectorAll('.legend-item').forEach(el=> el.classList.toggle('active', Number(el.dataset.id)===activeId));
    if (row && fly){
      const lat = parseFloat(pick(row, FIELD_ALIASES.lat));
      const lng = parseFloat(pick(row, FIELD_ALIASES.lng));
      if(!isNaN(lat)&&!isNaN(lng)) map.flyTo([lat,lng], 15);
    }
    markers.forEach(m=> m.setStyle({radius: m.__id===activeId? 9 : 6, fillOpacity: m.__id===activeId? 1 : 0.8 }));
    renderDetail(row);
  }

  function applyFilters(){
    const q = slug(els.search.value);
    const activeCats = Array.from(els.cats.querySelectorAll('.chip.active')).map(x=>x.dataset.value);
    const sortBy = els.sort.value;

    filtered = data.filter(r=>{
      const cats = splitCats(pick(r, FIELD_ALIASES.category));
      const inCat = activeCats.length ? cats.some(c=>activeCats.includes(c)) : true;
      const hay = slug([
        pick(r, FIELD_ALIASES.name),
        pick(r, FIELD_ALIASES.address),
        pick(r, FIELD_ALIASES.description),
        pick(r, FIELD_ALIASES.neighborhood),
        pick(r, FIELD_ALIASES.category),
        pick(r, FIELD_ALIASES.intake),
        pick(r, FIELD_ALIASES.geoElig),
        pick(r, FIELD_ALIASES.finElig)
      ].filter(Boolean).join(' '));
      const inSearch = q ? hay.includes(q) : true;
      return inCat && inSearch;
    });

    filtered.sort((a,b)=>{
      if(sortBy==='primary'){
        return slug(pick(a, FIELD_ALIASES.primary)).localeCompare(slug(pick(b, FIELD_ALIASES.primary)));
      }
      const key = sortBy==='name' ? FIELD_ALIASES.name : FIELD_ALIASES.neighborhood;
      return slug(pick(a, key)).localeCompare(slug(pick(b, key)));
    });

    renderMarkers(filtered);
    renderList(filtered);

    if (!filtered.find(r=>r.__id===activeId)) {
      activeId = null; renderDetail(null);
    } else if (activeId) {
      selectById(activeId, false);
    }
  }

  Papa.parse(CSV_URL, {
    download: true, header: true, skipEmptyLines: true,
    complete: function(results){
      headers = results.meta.fields || [];
      data = results.data.map((r,idx)=>{
        const cats = splitCats(pick(r, FIELD_ALIASES.category));
        cats.forEach(c=>practiceAreas.add(c));
        const primary = pick(r, FIELD_ALIASES.primary) || (cats[0]||'');
        return Object.assign({}, r, { __id: idx+1, _Category: cats.join(', '), _PrimaryCategory: primary });
      });
      renderCategories();
      applyFilters();
      els.search.addEventListener('input', applyFilters);
      els.sort.addEventListener('change', applyFilters);
    },
    error: function(err){ console.error('CSV load error', err); }
  });
})();
</script>
</body>
</html>
