<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Partners Map</title>

<link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>

<style>
  :root{
    --hotpink: hsla(323, 98%, 49%, 0.9);
    --hotpink-border: hsla(323, 98%, 35%, 1);
  }
  body{margin:0;font-family:"Inter Tight",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f8fafc;font-size:14px}
  .layout{display:grid;grid-template-columns:380px 1fr;gap:16px;min-height:100vh;padding:16px;box-sizing:border-box}
  .sidebar{display:flex;flex-direction:column;gap:12px}
  .controls{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
  .controls .row{margin-bottom:12px}
  .controls label{display:block;font-weight:600;margin-bottom:6px;font-size:14px}
  .row-inline{display:flex;align-items:center;justify-content:space-between;gap:8px}
  #search{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1px solid #d1d5db;border-radius:999px;padding:6px 10px;cursor:pointer;font-size:13px;user-select:none;background:#fff}
  .chip.active{background:#111827;color:#fff;border-color:#111827}

  .btn-clear{border:1px solid #d1d5db;background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
  .btn-clear:hover{background:#f3f4f6}

  .legend{background:#fff;border:1px solid #e5e7eb;border-radius:14px;overflow:auto;min-height:50vh}
  .legend-header{padding:10px 12px;font-weight:700;border-bottom:1px solid #f3f4f6}
  .legend-list .item{padding:10px 12px;border-bottom:1px solid #f3f4f6;cursor:pointer}
  .legend-list .item:last-child{border-bottom:none}
  .legend-list h4{margin:0;font-size:14px;line-height:1.25}
  .legend-list .meta{font-size:12px;color:#6b7280}
  .legend-list .item.active{background:#eef2ff}

  #map{border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;height:100%}

  /* floating detail panel */
  .detail{
    position:absolute;
    top:20px; right:20px;
    width:320px;
    max-height:60%;
    overflow:auto;
    background:#fff;
    border:1px solid #e5e7eb;
    border-radius:14px;
    padding:14px;
    box-shadow:0 4px 12px rgba(0,0,0,0.15);
    z-index:1000;
  }
  .detail h2{margin:0 0 6px 0;font-size:17px}
  .detail .kv{font-size:13px}
  .pill{display:inline-block;background:#111827;color:#fff;border-radius:999px;padding:2px 8px;font-size:11px;margin:2px 4px 0 0}
  .detail-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
  .detail-close{border:none;background:#f3f4f6;border-radius:10px;font-size:18px;line-height:1;padding:4px 10px;cursor:pointer}
  .detail-close:hover{background:#e5e7eb}

  .leaflet-container .leaflet-popup-content{font-family:"Inter Tight",system-ui,sans-serif;font-size:13px}
  .leaflet-container .leaflet-popup-content-wrapper{border-radius:10px}
  .leaflet-container .leaflet-popup-tip{opacity:.95}

  @media (max-width:720px){
    .layout{grid-template-columns:1fr}
    .detail{width:90%; right:5%; top:10px}
  }
</style>
</head>
<body>
<div class="layout">
  <aside class="sidebar">
    <div class="controls">
      <div class="row">
        <label>Search</label>
        <input id="search" type="text" placeholder="Search partners…"/>
      </div>
      <div class="row row-inline">
        <label style="margin:0">Practice Areas</label>
        <button id="clear-cats" class="btn-clear" type="button">Clear filters</button>
      </div>
      <div id="category-filters" class="chips"></div>
      <div class="row">
        <label>Sort by</label>
        <select id="sort">
          <option value="name">Name (A→Z)</option>
          <option value="primary">Main Practice Area (A→Z)</option>
          <option value="category">Practice Areas (A→Z)</option>
        </select>
      </div>
    </div>
    <div class="legend">
      <div class="legend-header"><span>Partners</span></div>
      <div id="list" class="legend-list"></div>
    </div>
  </aside>

  <main style="position:relative">
    <div id="map"></div>
    <section id="detail" class="detail">
      <div class="empty" style="color:#6b7280">Select a partner from the list or map…</div>
    </section>
  </main>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
// CSV URL
const CSV_URL='YOUR_CSV_LINK_HERE';

// simplified aliases for demo
const FIELD_ALIASES={
  name:['Name','_Name'],
  address:['Address','_Address'],
  lat:['Latitude','_Latitude'],
  lng:['Longitude','_Longitude'],
  website:['Website','_Website'],
  description:['Description','_Description'],
  category:['Category','_Category','Main Practice areas','Main Practice Areas'],
  primary:['PrimaryCategory','_PrimaryCategory'],
  intake:['Intake','_Intake'],
  geoElig:['Geographic Eligibility','_GeographicEligibility'],
  finElig:['Financial Eligibility','_FinancialEligibility']
};

let data=[],filtered=[],activeId=null;
const els={
  list:document.getElementById('list'),
  detail:document.getElementById('detail')
};

const map=L.map('map').setView([41.88,-87.63],11);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png',{
  maxZoom:19,attribution:'&copy; OpenStreetMap &copy; CARTO'
}).addTo(map);
const layerGroup=L.layerGroup().addTo(map);
const markers=[];

function pick(row,keys){for(const k of keys){if(row[k])return row[k];}return'';}

function popupHTML(r){
  const name=pick(r,FIELD_ALIASES.name);
  const addr=pick(r,FIELD_ALIASES.address);
  const site=pick(r,FIELD_ALIASES.website);
  return `<div style="font-family:'Inter Tight'"><b>${name}</b><br>${addr}<br>${site?`<a href="${site}" target="_blank">website</a>`:''}</div>`;
}

function renderDetail(r){
  if(!r){els.detail.innerHTML='<div class="empty">Select a partner…</div>';return;}
  const name=pick(r,FIELD_ALIASES.name);
  const addr=pick(r,FIELD_ALIASES.address);
  const site=pick(r,FIELD_ALIASES.website);
  const desc=pick(r,FIELD_ALIASES.description);
  els.detail.innerHTML=`
    <div class="detail-header"><h2>${name}</h2><button class="detail-close" onclick="els.detail.innerHTML='<div class=empty>Select a partner…</div>'">×</button></div>
    ${addr?`<div class="kv"><b>Address:</b> ${addr}</div>`:''}
    ${site?`<div class="kv"><b>Website:</b> <a href="${site}" target="_blank">${site}</a></div>`:''}
    ${desc?`<div class="section-title">About</div><div>${desc}</div>`:''}
  `;
}

function selectById(id){
  activeId=id;
  const r=filtered.find(x=>x.__id===id);
  renderDetail(r);
}

function renderMarkers(rows){
  layerGroup.clearLayers();markers.length=0;
  rows.forEach(r=>{
    const lat=parseFloat(pick(r,FIELD_ALIASES.lat));
    const lng=parseFloat(pick(r,FIELD_ALIASES.lng));
    if(isNaN(lat)||isNaN(lng))return;
    const m=L.circleMarker([lat,lng],{radius:6,color:'var(--hotpink-border)',fillColor:'var(--hotpink)',fillOpacity:.9});
    m.__id=r.__id;
    m.bindPopup(popupHTML(r));
    m.on('click',()=>{selectById(r.__id);m.openPopup();});
    layerGroup.addLayer(m);markers.push(m);
  });
  if(rows.length){map.fitBounds(layerGroup.getBounds(),{padding:[20,20]});}
}

function renderList(rows){
  els.list.innerHTML=rows.map(r=>`<div class="item" onclick="selectById(${r.__id})"><h4>${pick(r,FIELD_ALIASES.name)}</h4></div>`).join('');
}

// Load CSV
Papa.parse(CSV_URL,{
  download:true,header:true,complete:function(res){
    data=res.data.map((r,i)=>({...r,__id:i+1}));
    filtered=data;
    renderMarkers(filtered);
    renderList(filtered);
  }
});
</script>
</body>
</html>
