<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Partners Map</title>

<link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>

<style>
  :root{
    --hotpink: hsla(323, 98%, 49%, 0.9);
    --hotpink-border: hsla(323, 98%, 35%, 1);
  }
  body{margin:0;font-family:"Inter Tight",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f8fafc;font-size:14px}
  .layout{display:grid;grid-template-columns:380px 1fr;gap:16px;min-height:100vh;padding:16px;box-sizing:border-box}
  .sidebar{display:flex;flex-direction:column;gap:12px}
  .controls{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
  .controls .row{margin-bottom:12px}
  .controls label{display:block;font-weight:600;margin-bottom:6px;font-size:14px}
  .row-inline{display:flex;align-items:center;justify-content:space-between;gap:8px}
  #search{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1px solid #d1d5db;border-radius:999px;padding:6px 10px;cursor:pointer;font-size:13px;user-select:none;background:#fff}
  .chip.active{background:#111827;color:#fff;border-color:#111827}
  .btn-clear{border:1px solid #d1d5db;background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
  .btn-clear:hover{background:#f3f4f6}

  .legend{background:#fff;border:1px solid #e5e7eb;border-radius:14px;overflow:auto;min-height:50vh}
  .legend-header{padding:10px 12px;font-weight:700;border-bottom:1px solid #f3f4f6;color:var(--hotpink)}
  .legend-list .item{padding:10px 12px;border-bottom:1px solid #f3f4f6;cursor:pointer}
  .legend-list .item:last-child{border-bottom:none}
  .legend-list h4{margin:0;font-size:14px;line-height:1.25;color:var(--hotpink)} /* partner names hot pink */
 /* partner names hot pink by default */
.legend-list h4 {
  margin:0;
  font-size:14px;
  line-height:1.25;
  color:var(--hotpink);
}

/* turn selected one black (and bold) */
.legend-list .item.active h4 {
  color:#111827;
  font-weight:700;
}

/* keep meta text as-is */
.legend-list .meta {
  font-size:12px;
  color:#6b7280;
}

  /* RIGHT COLUMN: description ABOVE map */
  .stage{
    display:grid;
    grid-template-rows: auto minmax(460px,60vh); /* detail auto height, then map */
    gap:12px;
    align-content:start;
  }

  #map{
    border:1px solid #e5e7eb;
    border-radius:14px;
    overflow:hidden;
    height:100%;
  }

  .detail{
    background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px;position:relative;
  }
  .detail h2{margin:0 0 6px 0;font-size:17px}
  .detail .kv{font-size:13px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .kv b{font-weight:700}
  .kv a{text-decoration:underline}
  .section-title{margin-top:10px;font-weight:700;font-size:13px}
  .pill{display:inline-block;background:#111827;color:#fff;border-radius:999px;padding:2px 8px;font-size:11px;margin:2px 4px 0 0}
  .detail-header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:4px}
  .detail-close{border:none;background:#f3f4f6;border-radius:10px;font-size:18px;line-height:1;padding:4px 10px;cursor:pointer}
  .detail-close:hover{background:#e5e7eb}
  .detail .empty{color:var(--hotpink);font-weight:500} /* default message hot pink */

  /* popup styling */
  .leaflet-container .leaflet-popup-content{font-family:"Inter Tight",system-ui,sans-serif;font-size:13px}
  .leaflet-container .leaflet-popup-content-wrapper{border-radius:10px}
  .leaflet-container .leaflet-popup-tip{opacity:.95}

  @media (max-width:720px){
    .layout{grid-template-columns:1fr}
    .stage{grid-template-rows:auto 360px}
  }
</style>
</head>
<body>
<div class="layout">
  <aside class="sidebar">
    <div class="controls">
      <div class="row">
        <label>Search</label>
        <input id="search" type="text" placeholder="Search partners, services, or notes…"/>
      </div>

      <div class="row row-inline">
        <label style="margin:0">Practice Areas</label>
        <button id="clear-cats" class="btn-clear" type="button">Clear filters</button>
      </div>
      <div id="category-filters" class="chips"></div>

      <div class="row">
        <label>Sort by</label>
        <select id="sort">
          <option value="name">Name (A→Z)</option>
          <option value="primary">Main Practice Area (A→Z)</option>
          <option value="category">Practice Areas (A→Z)</option>
        </select>
      </div>
    </div>

    <div class="legend">
      <div class="legend-header"><span>Partners</span></div>
      <div id="list" class="legend-list" role="listbox" aria-label="Partner list"></div>
    </div>
  </aside>

  <main class="stage">
    <!-- description ABOVE the map -->
    <section id="detail" class="detail" aria-live="polite" aria-atomic="true">
      <div class="empty">Select a partner from the list of names to find out more!</div>
    </section>
    <div id="map"></div>
  </main>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
// CSV URL
const CSV_URL='https://docs.google.com/spreadsheets/d/e/2PACX-1vR1A8WkC-BbA94Ipm6Sit3qx5ndFoTG-zBBqnZPkNDEvHa11O0BJTRCWepWyo6RhqH58ZK1kQXO9v6P/pub?gid=1272818494&single=true&output=csv';

// simplified aliases for demo (case-insensitive mapping)
const FIELD_ALIASES={name:['Name','_Name'],address:['Address','_Address'],lat:['Latitude','_Latitude'],lng:['Longitude','_Longitude'],website:['Website','_Website'],description:['Description','_Description'],category:['Category','_Category','Main Practice areas','Main Practice Areas'],primary:['PrimaryCategory','_PrimaryCategory'],intake:['Intake','_Intake'],geoElig:['Geographic Eligibility','_GeographicEligibility'],finElig:['Financial Eligibility','_FinancialEligibility']};

let data=[],filtered=[],activeId=null;
const els={list:document.getElementById('list'),detail:document.getElementById('detail')};

const map=L.map('map').setView([41.88,-87.63],11);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap &copy; CARTO'}).addTo(map);
const layerGroup=L.layerGroup().addTo(map);const markers=[];

function pick(r,keys){for(const k of keys){if(r[k])return r[k];}return'';}
function splitCats(s){return(s||'').split(/[,;]/).map(v=>v.trim()).filter(Boolean);}

function renderDetail(r){
  if(!r){els.detail.innerHTML='<div class="empty">Select a partner from the list of names to find out more!</div>';return;}
  const name=pick(r,FIELD_ALIASES.name);
  const addr=pick(r,FIELD_ALIASES.address);
  const site=pick(r,FIELD_ALIASES.website);
  const desc=pick(r,FIELD_ALIASES.description);
  const cats=splitCats(pick(r,FIELD_ALIASES.category));
  const primary=pick(r,FIELD_ALIASES.primary)||cats[0]||'';
  const intake=pick(r,FIELD_ALIASES.intake);
  const geo=pick(r,FIELD_ALIASES.geoElig);
  const fin=pick(r,FIELD_ALIASES.finElig);
  const addrHtml=addr?`<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}" target="_blank">${addr}</a>`:'';
  els.detail.innerHTML=`
    <div class="detail-header"><h2>${name}</h2><button class="detail-close" onclick="renderDetail(null)">×</button></div>
    ${primary?`<div class="kv"><b>Main Practice Area:</b> ${primary}</div>`:''}
    ${cats.length?`<div>${cats.map(c=>`<span class="pill">${c}</span>`).join('')}</div>`:''}
    ${addrHtml?`<div class="kv"><b>Address:</b> ${addrHtml}</div>`:''}
    ${site?`<div class="kv"><b>Website:</b> <a href="${site}" target="_blank">${site}</a></div>`:''}
    ${desc?`<div class="section-title">About</div><div>${desc}</div>`:''}
    ${intake?`<div class="section-title">Intake</div><div>${intake}</div>`:''}
    ${geo?`<div class="section-title">Geographic Eligibility</div><div>${geo}</div>`:''}
    ${fin?`<div class="section-title">Financial Eligibility</div><div>${fin}</div>`:''}
  `;
}

function renderMarkers(rows){
  layerGroup.clearLayers();markers.length=0;
  rows.forEach(r=>{
    const lat=parseFloat(pick(r,FIELD_ALIASES.lat));
    const lng=parseFloat(pick(r,FIELD_ALIASES.lng));
    if(isNaN(lat)||isNaN(lng))return;
    const m=L.circleMarker([lat,lng],{radius:6,color:'var(--hotpink-border)',fillColor:'var(--hotpink)',fillOpacity:.9});
    m.__id=r.__id;
    m.on('click',()=>{activeId=r.__id;renderDetail(r);});
    layerGroup.addLayer(m);markers.push(m);
  });
  if(rows.length)map.fitBounds(layerGroup.getBounds(),{padding:[20,20]});
}

function renderList(rows){
  els.list.innerHTML=rows.map(r=>`<div class="item" onclick="renderDetail(data[${r.__id-1}])"><h4>${pick(r,FIELD_ALIASES.name)}</h4></div>`).join('');
}

Papa.parse(CSV_URL,{download:true,header:true,complete:res=>{
  data=res.data.map((r,i)=>({...r,__id:i+1}));
  filtered=data;renderMarkers(filtered);renderList(filtered);
}});
</script>
</body>
</html>
